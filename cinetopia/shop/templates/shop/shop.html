{% extends 'cinema/base.html' %}
{% load static %}

{% block title %}–ú–∞–≥–∞–∑–∏–Ω | üéüÔ∏èCinetopia{% endblock %}
{% block head %}
  <link rel="stylesheet" href="{% static 'shop/css/styles.css' %}">
{% endblock %}

{% block main %}
  <main class="shop-container">
    <aside class="filters">
      <div class="filter-section">
        <span class="filter-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
        <div class="filter-option {% if not selected_category %}active{% endif %}">
          <a href="?">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</a>
        </div>
        {% for value, name in categories.items %}
          <div class="filter-option {% if selected_category == value %}active{% endif %}">
            <a href="?category={{ value }}">{{ name }}</a>
          </div>
        {% endfor %}
      </div>

      <div class="filter-section">
        <span class="filter-title">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
        {% for value, name in sort_options.items %}
          <div class="filter-option {% if selected_sort == value %}active{% endif %}">
            <a href="?sort={{ value }}{% if selected_category %}&category={{ selected_category }}{% endif %}">{{ name }}</a>
          </div>
        {% endfor %}
      </div>
    </aside>

    <div class="products-container">
      <div class="sorting">
        <h2>{% if selected_category %}{% else %}–í—Å–µ —Ç–æ–≤–∞—Ä—ã{% endif %}</h2>
        <span>{{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä–æ–≤</span>
      </div>
      <div class="products">
        {% for product in page_obj %}
          <div class="product-card" data-product-id="{{ product.id }}">
            <a href="#" class="product-image-link">
              <div class="product-image">
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
              </div>
            </a>
            <div class="product-info">
              <h3 class="product-title">
                <a href="#">{{ product.name }}</a>
              </h3>
              <div class="product-price">
                {{ product.get_price|floatformat:2 }} {{ product.currency }}
                {% if product.discount > 0 %}
                  <span class="old-price">{{ product.price|floatformat:2 }} {{ product.currency }}</span>
                  <span class="discount-badge">-{{ product.discount }}%</span>
                {% endif %}
              </div>
              <div class="product-actions">
                <button class="add-to-cart-btn" data-product-id="{{ product.id }}">
                  –í –∫–æ—Ä–∑–∏–Ω—É
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page=1{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}">&laquo;</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}">{{ page_obj.previous_page_number }}</a>
          {% endif %}

          <a href="#" class="active">{{ page_obj.number }}</a>

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}">{{ page_obj.next_page_number }}</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}">&raquo;</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </main>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
    function updateButtonState(productId, inCart = false) {
        const btn = $(`.add-to-cart-btn[data-product-id="${productId}"]`);
        if (inCart) {
            btn.addClass('in-cart').text('–í –∫–æ—Ä–∑–∏–Ω–µ');
        } else {
            btn.removeClass('in-cart').text('–í –∫–æ—Ä–∑–∏–Ω—É');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ
    function checkCartState() {
        $.ajax({
            url: '/cart/',
            method: 'GET',
            success: function(data) {
                // –ü–∞—Ä—Å–∏–º HTML –æ—Ç–≤–µ—Ç–∞ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫–æ—Ä–∑–∏–Ω–µ
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(data, 'text/html');
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                const cartItems = htmlDoc.querySelectorAll('.cart-item');
                const cartItemsMap = {};
                
                cartItems.forEach(item => {
                    const productId = item.dataset.productId;
                    cartItemsMap[productId] = true;
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                $('.add-to-cart-btn').each(function() {
                    const productId = $(this).data('product-id');
                    updateButtonState(productId, cartItemsMap[productId]);
                });
            }
        });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkCartState();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–í –∫–æ—Ä–∑–∏–Ω—É"/"–í –∫–æ—Ä–∑–∏–Ω–µ"
    $('.add-to-cart-btn').click(function(e) {
        e.preventDefault();
        const productId = $(this).data('product-id');
        const isInCart = $(this).hasClass('in-cart');
        
        if (isInCart) {
            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ - —É–¥–∞–ª—è–µ–º –µ–≥–æ
            $.ajax({
                url: `/cart/remove/${productId}/`,
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        updateButtonState(productId, false);
                        updateCartIndicator(data.cart_total_items);
                    }
                }
            });
        } else {
            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ - –¥–æ–±–∞–≤–ª—è–µ–º
            $.ajax({
                url: `/cart/add/${productId}/`,
                method: 'POST',
                data: JSON.stringify({
                    quantity: 1,
                    update: false
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        updateButtonState(productId, true);
                        updateCartIndicator(data.cart_total_items);
                    }
                }
            });
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–æ—Ä–∑–∏–Ω—ã –≤ —à–∞–ø–∫–µ
    function updateCartIndicator(count) {
        $('.cart-count').remove();
        if (count > 0) {
            $('#cart').append(`
                <span class="cart-count">${count}</span>
            `);
        }
    }
});
</script>
{% endblock %}